<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://samuel-cavalcanti.github.io/Tutorials/main.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <title>  | Tutorial MPI </title>
</head>
<body>

<main>
    
    <nav>
            <a href="https:&#x2F;&#x2F;samuel-cavalcanti.github.io&#x2F;Tutorials&#x2F;">
                        <img src="https://samuel-cavalcanti.github.io/Tutorials/npad_logo.png" alt="logo"/>
                    </a>
                <a href="javascript:void(0);" onclick="burger()" id="mobile" class="ms-Icon--GlobalNavButton"></a>
            <div id="trees">
                <input class="tree-toggle" type="checkbox" id="intermediario"
                           />
                    <label class="tree-toggle-label"
                           for="intermediario">intermediário</label>

                    <ul class="subtree">
                        <li >
                                <a href="https://samuel-cavalcanti.github.io/Tutorials/intermediate/superpc-introduction-part-3/">Tutorial Introdução ao Supercomputador - Parte 3</a>
                            </li>

                            <li >
                                <a href="https://samuel-cavalcanti.github.io/Tutorials/intermediate/slurm-commands/">Tutorial de comandos do supercomputador</a>
                            </li>

                            <li >
                                <a href="https://samuel-cavalcanti.github.io/Tutorials/intermediate/install-apps/">Tutorial de instalação de programas no supercomputador</a>
                            </li>

                            </ul>
                <input class="tree-toggle" type="checkbox" id="iniciante"
                           />
                    <label class="tree-toggle-label"
                           for="iniciante">iniciante</label>

                    <ul class="subtree">
                        <li >
                                <a href="https://samuel-cavalcanti.github.io/Tutorials/beginner/putty-tutorial/">PuTTy tutoriais</a>
                            </li>

                            <li >
                                <a href="https://samuel-cavalcanti.github.io/Tutorials/beginner/ssh-tutorial/">Geração de chave SSH pública</a>
                            </li>

                            <li >
                                <a href="https://samuel-cavalcanti.github.io/Tutorials/beginner/rsync-tutorial/">rsync</a>
                            </li>

                            <li >
                                <a href="https://samuel-cavalcanti.github.io/Tutorials/beginner/superpc-introduction-part-1/">Tutorial Introdução ao Supercomputador parte 1</a>
                            </li>

                            <li >
                                <a href="https://samuel-cavalcanti.github.io/Tutorials/beginner/mobaxterm-tutorial/">MobaXterm Tutoriais</a>
                            </li>

                            <li >
                                <a href="https://samuel-cavalcanti.github.io/Tutorials/beginner/superpc-introduction-part-2/">Tutorial Introdução ao Supercomputador - Parte 2</a>
                            </li>

                            <li >
                                <a href="https://samuel-cavalcanti.github.io/Tutorials/beginner/winscp-tutorial/">Copiando Arquivos através de uma Interface gráfica WinSCP (Windows)</a>
                            </li>

                            <li >
                                <a href="https://samuel-cavalcanti.github.io/Tutorials/beginner/gnome-files/">Copiando Arquivos através de uma Interface gráfica Gnome Files (linux)</a>
                            </li>

                            <li >
                                <a href="https://samuel-cavalcanti.github.io/Tutorials/beginner/scp-tutorial/">scp</a>
                            </li>

                            </ul>
                <input class="tree-toggle" type="checkbox" id="avancado"
                           checked/>
                    <label class="tree-toggle-label"
                           for="avancado">avançado</label>

                    <ul class="subtree">
                        <li class="active">
                                <a href="https://samuel-cavalcanti.github.io/Tutorials/advanced/mpi-tutorial/">Tutorial MPI</a>
                            </li>

                            
                                    
                                    
                                        <ul id="toc">
                                            <li><a href="
                                                        https://samuel-cavalcanti.github.io/Tutorials/advanced/mpi-tutorial/#tutorial-mpi">Tutorial MPI</a>
                                                    <ul>
                                                            <li>
                                                                    <a href="https://samuel-cavalcanti.github.io/Tutorials/advanced/mpi-tutorial/#passo-1-conexao-ao-supercomputador-por-ssh">Passo 1: Conexão ao supercomputador por SSH</a>
                                                                </li>
                                                            <li>
                                                                    <a href="https://samuel-cavalcanti.github.io/Tutorials/advanced/mpi-tutorial/#passo-2-criacao-de-um-programa-mpi">Passo 2: Criação de um programa MPI</a>
                                                                </li>
                                                            <li>
                                                                    <a href="https://samuel-cavalcanti.github.io/Tutorials/advanced/mpi-tutorial/#passo-3-compilacao-do-programa-mpi">Passo 3: Compilação do programa MPI</a>
                                                                </li>
                                                            <li>
                                                                    <a href="https://samuel-cavalcanti.github.io/Tutorials/advanced/mpi-tutorial/#passo-4-execucao-do-programa-no-supercomputador">Passo 4: Execução do programa no supercomputador</a>
                                                                </li>
                                                            </ul>
                                                    </li>
                                            </ul>
                                    <li >
                                <a href="https://samuel-cavalcanti.github.io/Tutorials/advanced/tch-rs-tutorial/">tch-rs-example NMIST</a>
                            </li>

                            <li >
                                <a href="https://samuel-cavalcanti.github.io/Tutorials/advanced/openmp-tutorial/">Tutorial OpenMP</a>
                            </li>

                            </ul>
                </div>
        </nav>
    <article>

        <div id="on_right">
                <span id="search-ico" class="ms-Icon--Search"></span>
            </div>
            <div class="search-container">
                <input id="search" type="search" placeholder="Search as you type...">
                <div class="search-results">
                    <div class="search-results__header"></div>
                    <ul class="search-results__items"></ul>
                </div>
            </div>
        <div id="wrap">
            
        <h1 id="tutorial-mpi">Tutorial MPI</h1>
<p>Nesse tutorial iremos aprender a conduzir a execução de aplicações utilizando o Intel MPI no supercomputador, uma das melhores implementações MPI da indústria, de maneira simples e prática.</p>
<p>O MPI é um padrão de troca de mensagens para uso em computação paralela, oferecendo uma infraestrutura para a criação de programas que utilizem recursos de CPU e memória de múltiplos computadores em um cluster ou nós em um supercomputador, além de permitir a passagem coordenada de mensagens entre processos.</p>
<p>Definindo um padrão industrial para a troca de mensagens, existem diversas implementações do MPI. Iremos utilizar o Intel MPI juntamente com o gerenciador de recursos SLURM de acordo com os passos a seguir:</p>
<ol>
<li>Conexão ao supercomputador por SSH</li>
<li>Criação de um programa MPI</li>
<li>Compilação do programa MPI</li>
<li>Execução do programa no supercomputador</li>
</ol>
<h2 id="passo-1-conexao-ao-supercomputador-por-ssh">Passo 1: Conexão ao supercomputador por SSH</h2>
<p>Para se conectar ao supercomputador é necessário utilizar o SSH já disponível por padrão na maioria dos sistemas Unix como nas distribuições Linux e todas as versões do Mac OS X assim como disponível livremente na Internet como download para a plataforma Windows. O cliente SSH mais popular da plataforma Windows é o <a href="https://samuel-cavalcanti.github.io/Tutorials/beginner/putty-tutorial/">Putty</a></p>
<p>Iremos nesse tutorial utilizar como padrão a plataforma Linux, mas sua execução no Windows segue os mesmos princípios.</p>
<p>Para se conectar no nó de login do supercomputador basta executar o seguinte comando:</p>
<pre data-lang="bash" style="background-color:#eff1f5;color:#4f5b66;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">aluno@ubuntu:~</span><span> $ ssh</span><span style="color:#bf616a;"> -p</span><span> 4422 USUARIO@sc2.npad.ufrn.br
</span></code></pre>
<p>Troque <strong>USUARIO</strong> pelo seu nome de usuário já autorizado. Você deve visualizar uma tela com notícias sobre o supercomputador e a criação dos seus diretórios pessoais.</p>
<p>Nesse momento você já está conectado ao supercomputador no ambiente Linux da máquina em sua área pessoal de arquivos. Todos os comandos padrão da distribuição CentOS assim como alguns editores de texto como o 'Emacs' e 'Vi' estão disponíveis para que você possa manipular seus arquivos e pastas pessoais. Nesse momento você já está conectado ao supercomputador no ambiente Linux da máquina em sua área pessoal de arquivos. Todos os comandos padrão da distribuição CentOS assim como alguns editores de texto como o 'Emacs' e 'Vi' estão disponíveis para que você possa manipular seus arquivos e pastas pessoais.</p>
<h2 id="passo-2-criacao-de-um-programa-mpi">Passo 2: Criação de um programa MPI</h2>
<p>O esqueleto de um programa MPI é estruturado da seguinte forma:</p>
<ul>
<li>Inclusão do cabeçalho mpi.h e dos demais cabeçalhos necessários ao programa</li>
<li>Início do programa indicado pela linha de código &quot;int main (int argc, char *argv[])&quot;</li>
<li>Código sequencial opcional, por exemplo: inicialização de variáveis</li>
<li>Inicialização do código paralelo indicado pela linha de código &quot;MPI_Init(&amp;argc, &amp;argv);&quot;</li>
<li>Leitura da quantidade de processos criados indicado pela linha de código &quot;MPI_Comm_size(MPI_COMM_WORLD, &amp;comm_sz);&quot;</li>
<li>Leitura do rank do processo utilizado, indicado pela linha de código &quot;MPI_Comm_rank(MPI_COMM_WORLD, &amp;comm_sz);&quot;</li>
<li>Código paralelo</li>
<li>Finalização do código paralelo indicado pela linha de código &quot;MPI_Finalize();&quot;</li>
<li>Código sequencial opcional e finalização do programa</li>
</ul>
<p>Um exemplo de programa MPI é ilustrado abaixo. Copie esse programa para um arquivo na sua pasta pessoal e salve com o nome &quot;mpi_hello.c&quot;. A função desse programa é imprimir uma mensagem de forma paralela a partir de processos diferentes. Esses processos podem estar no mesmo nó, utilizando diferentes núcleos, ou podem estar em nós diferentes. Essa escolha é feita pelo usuário a partir dos parâmetros utilizados no script de submissão que será mostrado numa seção (ou passo) posterior.</p>
<pre data-lang="c" style="background-color:#eff1f5;color:#4f5b66;" class="language-c "><code class="language-c" data-lang="c"><span style="color:#b48ead;">#include </span><span>&lt;</span><span style="color:#a3be8c;">stdlib.h</span><span>&gt;
</span><span style="color:#b48ead;">#include </span><span>&lt;</span><span style="color:#a3be8c;">stdio.h</span><span>&gt;
</span><span style="color:#b48ead;">#include </span><span>&lt;</span><span style="color:#a3be8c;">mpi.h</span><span>&gt;
</span><span>
</span><span style="color:#b48ead;">int </span><span style="color:#8fa1b3;">main </span><span>(</span><span style="color:#b48ead;">int </span><span style="color:#bf616a;">argc</span><span>, </span><span style="color:#b48ead;">char </span><span>*</span><span style="color:#bf616a;">argv</span><span>[])
</span><span>{
</span><span>  </span><span style="color:#b48ead;">int</span><span>  rank, comm_sz, len;
</span><span>  </span><span style="color:#b48ead;">char</span><span> hostname[MPI_MAX_PROCESSOR_NAME];
</span><span>  
</span><span>  </span><span style="color:#bf616a;">MPI_Init</span><span>(&amp;argc, &amp;argv);
</span><span>  </span><span style="color:#bf616a;">MPI_Comm_size</span><span>(MPI_COMM_WORLD, &amp;comm_sz);
</span><span>  </span><span style="color:#bf616a;">MPI_Comm_rank</span><span>(MPI_COMM_WORLD, &amp;rank);
</span><span>
</span><span>  </span><span style="color:#bf616a;">MPI_Get_processor_name</span><span>(hostname, &amp;len);
</span><span>  </span><span style="color:#96b5b4;">printf </span><span>(&quot;</span><span style="color:#a3be8c;">Hello from process </span><span style="color:#d08770;">%d</span><span style="color:#a3be8c;"> on node </span><span style="color:#d08770;">%s</span><span style="color:#a3be8c;">!</span><span style="color:#96b5b4;">\n</span><span>&quot;, rank, hostname);
</span><span>  </span><span style="color:#b48ead;">if </span><span>(rank == </span><span style="color:#d08770;">0</span><span>)
</span><span>    </span><span style="color:#96b5b4;">printf</span><span>(&quot;</span><span style="color:#a3be8c;">From process </span><span style="color:#d08770;">%d</span><span style="color:#a3be8c;">: Number of MPI processes is </span><span style="color:#d08770;">%d</span><span style="color:#96b5b4;">\n</span><span>&quot;, rank, comm_sz);
</span><span>
</span><span>  </span><span style="color:#bf616a;">MPI_Finalize</span><span>();
</span><span>}
</span></code></pre>
<h2 id="passo-3-compilacao-do-programa-mpi">Passo 3: Compilação do programa MPI</h2>
<p>De posse do arquivo <code>mpi_hello.c</code>, você pode compilar o mesmo com o comando “mpiicc” da seguinte forma:</p>
<pre data-lang="bash" style="background-color:#eff1f5;color:#4f5b66;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">[seuUsuario@service0 ~</span><span>]$  mpiicc mpi_hello.c</span><span style="color:#bf616a;"> -o</span><span> mpi_hello 
</span><span style="color:#bf616a;">[seuUsuario@service0 ~</span><span>]$  ls 
</span><span style="color:#bf616a;">mpi_hello.c</span><span>   mpi_hello
</span></code></pre>
<p>A compilação gerou com sucesso o arquivo binário “mpi_hello” que será executado em vários núcleos de processadores do supercomputador no próximo passo.</p>
<h2 id="passo-4-execucao-do-programa-no-supercomputador">Passo 4: Execução do programa no supercomputador</h2>
<p>No supercomputador é utilizado o gerenciador de recursos SLURM para se executar tarefas em diversos processadores da máquina. Tradicionalmente usuários do MPI utilizam o comando “mpirun” ou “mpiexec”, mas no nosso ambiente iremos utilizar o SLURM com o comando “sbatch” que recebe um script bash contendo configurações específicas sobre os recursos desejados, assim como que programa será executado pela sua tarefa. Esse script é chamado oficialmente de “Job submission file”.</p>
<h3 id="exemplo-de-script-mais-simples">Exemplo de script mais simples</h3>
<p>Para executar 4 tarefas do programa “mpi_hello” devemos criar um script chamado, por exemplo, de “jobMPI.sh” com o conteúdo abaixo:</p>
<pre data-lang="bash" style="background-color:#eff1f5;color:#4f5b66;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#a7adba;">#!/bin/bash
</span><span>
</span><span style="color:#bf616a;">srun --time</span><span>=0-0:5</span><span style="color:#bf616a;"> -n4</span><span> mpi_hello
</span></code></pre>
<p>Para enviar esse “job” para a fila de execução usamos o comando:</p>
<pre data-lang="bash" style="background-color:#eff1f5;color:#4f5b66;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">[seuUsuario@service0 ~</span><span>]$  sbatch jobMPI.sh 
</span><span>
</span><span style="color:#bf616a;">Submitted</span><span> batch job 2230
</span></code></pre>
<p>Esse comando irá adicionar o “job” na fila de execução e retornar um id (nesse caso 2230) dessa nova tarefa adicionada. Para monitorar a tarefa você pode usar o comando <code>squeue</code> para visualizar todas as tarefas em andamento. Se desejar cancelar uma tarefa em execução utilize o comando <code>scancel JOB_ID</code>.</p>
<p>Ao finalizar sua execução o SLURM cria automaticamente um arquivo chamado “slurm-JOB_ID.out” com a saída padrão de sua tarefa redirecionada para esse arquivo. O nome do arquivo contém o ID do job enviado (JOB_ID) para facilitar sua relação com o mesmo. Isso é importante se seu programa gera uma saída padrão que contém um resultado útil da sua execução. Veja abaixo o resultado da execução do simples script que criamos e sua saída em arquivos:</p>
<pre data-lang="bash" style="background-color:#eff1f5;color:#4f5b66;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">[seuUsuario@service0 ~</span><span>]$  sbatch jobMPI.sh 
</span><span>
</span><span style="color:#bf616a;">Submitted</span><span> batch job 2230
</span><span>
</span><span style="color:#bf616a;">[seuUsuario@service0 ~</span><span>]$  cat slurm-2230.out 
</span><span>
</span><span style="color:#bf616a;">Hello</span><span> from process 3 on node r1i2n16!
</span><span>
</span><span style="color:#bf616a;">Hello</span><span> from process 2 on node r1i2n16!
</span><span>
</span><span style="color:#bf616a;">Hello</span><span> from process 1 on node r1i2n16!
</span><span>
</span><span style="color:#bf616a;">Hello</span><span> from process 0 on node r1i2n16!
</span><span>
</span><span style="color:#bf616a;">From</span><span> process 0: Number of MPI processes is 4
</span></code></pre>
<p>Repare que todas as 4 tarefas foram executadas no mesmo nó (neste caso o r1i2n16), pois o SLURM só foi instruído para executar 4 tarefas e nada mais.</p>
<h3 id="exemplo-de-script-mais-detalhado">Exemplo de script mais detalhado</h3>
<p>Um exemplo de script que solicita que 4 tarefas do programa “mpi_hello” executem em 2 nós diferentes é mostrado abaixo:</p>
<pre data-lang="bash" style="background-color:#eff1f5;color:#4f5b66;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#a7adba;">#!/bin/bash
</span><span style="color:#a7adba;">#SBATCH --job-name=MPI_hello  
</span><span style="color:#a7adba;">#SBATCH --output=saida%j.out
</span><span style="color:#a7adba;">#SBATCH --error=erro%j.err
</span><span style="color:#a7adba;">#SBATCH --nodes=2
</span><span style="color:#a7adba;">#SBATCH --ntasks-per-node=2
</span><span style="color:#a7adba;">#SBATCH --cpus-per-task=1
</span><span style="color:#a7adba;">#SBATCH --time=0-0:5
</span><span>
</span><span style="color:#bf616a;">srun</span><span> mpi_hello
</span></code></pre>
<p>Repare que agora o script contém vários parâmetros que foram adicionados. A descrição desses parâmetros é informada abaixo:</p>
<ul>
<li><code>job-name</code>: Nome que aparecerá na fila de jobs</li>
<li><code>output</code>: Arquivo de saída padrão do programa</li>
<li><code>error</code>: Arquivo de saída de erro do programa</li>
<li><code>nodes</code>: Quantidade de nós alocados para o programa</li>
<li><code>ntasks-per-node</code>: Número de processos em um mesmo nó (normalmente 1 para jobs OpenMP) - Útil para jobs MPI</li>
<li><code>cpus-per-task</code>: Número de núcleos de CPU alocados para um processo do programa</li>
<li><code>time</code>: Tempo máximo para execução do job (nesse exemplo = 5 min). Caso o job ainda não tenha terminado, após esse tempo ele será cancelado. Formato: dias-horas:minutos</li>
</ul>
<p>Observa-se, então, que foram requisitados 2 (valor de --nodes) nós para os jobs e que em cada nó serão criados 2 (valor de --ntasks-per-node) processos. O comando “srun mpi_hello” agora não deve mais conter o número de tarefas que será executada, uma vez que isso já está definido anteriormente no script. Veja sua execução:</p>
<pre data-lang="bash" style="background-color:#eff1f5;color:#4f5b66;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">[seuUsuario@service0 ~</span><span>]$  sbatch jobMPI.sh 
</span><span>
</span><span style="color:#bf616a;">Submitted</span><span> batch job 2236
</span><span>
</span><span style="color:#bf616a;">[seuUsuario@service0 ~</span><span>]$  cat slurm-2236.out 
</span><span>
</span><span style="color:#bf616a;">Hello</span><span> from process 3 on node r1i1n2!
</span><span>
</span><span style="color:#bf616a;">Hello</span><span> from process 2 on node r1i1n2!
</span><span>
</span><span style="color:#bf616a;">Hello</span><span> from process 1 on node r1i3n5!
</span><span>
</span><span style="color:#bf616a;">Hello</span><span> from process 0 on node r1i3n5!
</span><span>
</span><span style="color:#bf616a;">From</span><span> process 0: Number of MPI processes is 4
</span></code></pre>
<p>Repare que agora as 4 tarefas foram executadas em dois nós distintos (r1i1n2 e r1i3n5), exatamente da forma que instruímos.</p>
<p>Assim finalizamos nosso tutorial Intel MPI. Para mais informações sobre o Intel MPI e o SLURM acesse os links abaixo:</p>
<ul>
<li><a href="http://slurm.schedmd.com/">http://slurm.schedmd.com/</a></li>
<li><a href="https://software.intel.com/en-us/intel-mpi-library">https://software.intel.com/en-us/intel-mpi-library</a></li>
</ul>

    
        </div>

    </article>
</main>


    <script type="text/javascript" src="https://samuel-cavalcanti.github.io/Tutorials/elasticlunr.min.js" defer></script>
    <script type="text/javascript" src="https://samuel-cavalcanti.github.io/Tutorials/search_index.en.js" defer></script>
<script type="text/javascript" src="https://samuel-cavalcanti.github.io/Tutorials/js.js" defer></script>

</body>
</html>
